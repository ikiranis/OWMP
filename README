Parrot Tunes (Open Web Media Library and Player)


ΕΓΚΑΤΑΣΤΑΣΗ

- Δημιουργούμε μία βάση στην mysql. Δεν χρειάζεται να γίνει import κάποιο sql script.
Η εφαρμογή θα δημιουργήσει αυτόματα όλο το structure της βάσης

- Κατεβάζουμε τα αρχεία της εφαρμογής στον φάκελο που θέλουμε στον web server. Ή με download ή απευθείας με git
    git clone https://rocean@bitbucket.org/rocean/owmp.git /myWebServerPath

- Μετονομάζουμε το libraries/config.inc.php.sample σε libraries/config.inc.php και βάζουμε τα στοιχεία της mysql
    Επίσης πειράζουμε την γραμμή
        define ('PROJECT_PATH','/OpenWebMediaPlayer/');
    και βάζουμε το directory στο οποίο έχουμε κατεβάσει την εφαρμογή
        define ('PROJECT_PATH','/');
    αν είναι στο root του web server.

ΑΡΧΙΚΕΣ ΡΥΘΜΙΣΕΙΣ

- Τρέχουμε την εφαρμογή και δημιουργούμε τον πρώτο admin χρήστη. Με την δημιουργία του χρήστη δημιουργούνται αυτόματα
και οι αρχικές τιμές στα options

- Κάνουμε login στην εφαρμογή και πάμε στις ρυθμίσεις, στα options

    Στο convert_alac_files βάζουμε true αν θέλουμε να μετατρέπει τα ALAC αρχεία σε απλά mp3. Αλλιώς η εφαρμογή αδιαφορεί
    για τα ALAC.

    Στο playlist_limit βάζουμε τον αριθμό των εγγραφών που θα εμφανίζονται σε κάθε σελίδα στην playlist. Για default
    έχει την τιμή 150. Προσοχή αν βάλουμε μεγάλο αριθμό, γιατί θα έχουμε πρόβλημα επιδόσεων της εφαρμογής

    Στο dir_prefix βάζουμε το αρχικό κομμάτι του path των αρχείων μας. Αυτό κυρίως όταν θέλουμε να γίνει συγχρονισμός
    με itunes. Διάβασε παρακάτω πιο αναλυτικά γι' αυτό. Για default έχει το '/'. Δεν το πειράζουμε αν δεν μας
    ενδιαφέρει ο συγχρονισμός με itunes.

    Στο syncItunes βάζουμε true αν θέλουμε να γίνεται συγχρονισμός με itunes. Το έχουμε σε true για να κάνουμε τον
    συγχρονισμό. Αφού κάνουμε τον συγχρονισμό το βάζουμε πάλι σε false, αλλιώς θα αργεί μετά στον συγχρονισμό, χωρίς
    λόγο.

    Στο web_folder_path βάζουμε το web folder του server. By default /var/www/html/

    Στο date_format έχει το format με βάση το οποίο θα εμφανίζονται οι ημερομηνίες. π.χ. d-m-Y για να εμφανίζονται στην
    μορφή 14-12-2010.

- Πάμε στην Συλλογή, στις διαδρομές αρχείων. Προσθέτουμε το πλήρες linux path (ένα ή περισσότερα) των φακέλων που
βρίσκεται η μουσική μας. Διαλέγουμε αν είναι Music (mp3, m4a) ή Music Video (mp4, m4v).

    ΠΡΟΣΟΧΗ (επειδή ακόμη δεν γίνεται έλεγχος από την εφαρμογή): Επιλέγουμε ότι είναι main όταν βάζουμε μόνο ένα path
    για κάθε media kind. Αν βάζουμε παραπάνω από ένα path σε καποιο media kind τότε βάζουμε main σε αυτό που θέλουμε
    να είναι το βασικό και στα υπόλοιπα not main.

    Το path που είναι main χρησιμοποιείται από την εφαρμογή για download (π.χ. youtube download) ή για σώσιμο των
    cover artworks των mp3.

    Για κάθε media kind (Music/Music Video) σετάρουμε δηλαδή κι ένα main path.

    ΠΡΟΣΟΧΗ: Αν το path που θα βάλουμε είναι έξω από το web directory (π.χ. /var/www/html/) του server πρέπει να
    ορίσουμε alias στο virtualhost για το κάθε path (οδηγίες παρακάτω)

    Αν το path είναι μέσα στο web folder (π.χ /var/www/html/) τότε για path (για videos π.χ.) βάζουμε κάτι σαν αυτό
    /var/www/html/myVideos και φυσικά δεν χρειάζεται να προσθέσουμε alias στο virtualhost. Για να παίξει σωστά όμως
    πρέπει να πειράξετε πιθανά την τιμή του web_folder_path στα options. By default έχει την τιμή var/www/html/
    Οπότε αν αυτό είναι το web folder σας, τότε δεν χρειάζετε να πειράξετε κάτι. Αλλιώς βάζετε το δικό σας. Προσοχή
    να μην έχει κάθετο '/' στην αρχή. Μόνο στο τέλος.



ΕΝΗΜΕΡΩΣΗ ΤΟΥ VIRTUALHOST ΣΤΟΝ APACHE ΜΕ ΤΑ PATHS ΤΩΝ ΑΡΧΕΙΩΝ ΜΑΣ

Για να μπορούμε να έχουμε πρόσβαση στα αρχεία μουσικής μας από το web πρέπει να βάλουμε τα paths και στο
virtualhost του apache, σαν alias.

Κάνουμε edit το αρχείο

sudo nano /etc/apache2/sites-enabled/000-default.conf

Αν υποθέσουμε ότι το path των αρχείων μας είναι στο /media/myDisk/myDirectory

Κάπου ανάμεσα στα  <VirtualHost *:80>  </VirtualHost>

βάζουμε τις παρακάτω γραμμές, για κάθε ξεχωριστό path

Alias /media/myDisk/myDirectory "/media/myDisk/myDirectory"
<Directory "/media/myDisk/myDirectory">
     Order allow,deny
     Allow from all
     Require all granted
</Directory>

κάνουμε restart τον Apache

sudo service apache2 restart



ΣΥΓΧΡΟΝΙΣΜΟΣ

- Αφού σετάρουμε όλα αυτά επιλέγουμε στην συλλογή παρακάτω το media kind που θέλουμε και πατάμε Συγχρονισμός.
Ο συγχρονισμός μπορεί να πάρει από μερικά λεπτά μέχρι πάρα πολλές ώρες. Αναλόγως πόσο μεγάλη είναι η συλλογή μας.
Φυσικά για τα βιντεοκλιπς πολύ περισσότερο από τα mp3, γιατί πρέπει να διαβάσει μεγαλύτερα αρχεία.
Αν κλείσουμε το tab ο συγχρονισμός συνεχίζει στον apache. Καλό είναι να μην γίνει αυτό όμως, γιατί η εφαρμογή δεν
κάνει ακόμη σωστούς ελέγχους για το proccess που τρέχει και θα χρειαστεί να πειραχτεί ο κώδικας για να μπορέσεις
να ξανακάνεις συγχρονισμό μετά. Κι αν κάνεις συγχρονισμό χωρίς να τελειώσει ο προηγούμενος θα δημιουργήσει μια
βάση δεδομένων μπάχαλο. Για τα αρχεία μας δεν υπάρχει πρόβλημα. Δεν πειράζει τίποτα (εκτός από τα ALAC. Διάβασε
παρακάτω)


ΣΥΓΧΡΟΝΙΣΜΟΣ ΜΕ ITUNES

Για να κάνουμε συγχρονισμό με itunes (δηλαδή να πάρει όλα τα metadata για κάθε αρχείο μας που είχαμε βάλει στο itunes)
κάνουμε export της playlist μας στο itunes, σε xml. Παίρνουμε το xml, το ονομάζουμε 'Library.xml' (οπωσδήποτε)
και το βάζουμε στο root directory όπου είναι η εφαρμογή μας στον web server.

Για να γίνει ο συγχρονισμός ελέγχονται τα paths που βάζει το itunes στο xml με τα paths που έχουμε τα αρχεία.
π.χ. στο mac το path στο itunes έχει την μορφή file://localhost/Volumes/disk...... Ενώ σε linux έχει την μορφή
 /media/disk......

Επειδή αυτό που σώζει το itunes (το αρχικό μέρος) είναι διαφορετικής μορφής από το path που έχουμε στο linux,
η εφαρμογή κόβει το αρχικό κομμάτι, ώστε να γίνεται σωστός έλεγχος.

Αυτός είναι και ο λόγος που υπάρχει το dir_prefix στα options. Αν το path μας στο linux είναι στο
/media/disk/directory.... τότε βάζουμε για dir_prefix το '/media/' (με τις 2 καθέτους).

Αν το path μας είναι /disk/directory.... τότε το αφήνουμε '/'

Στην συνέχεια βάζουμε true στο syncItunes στα options και κάνουμε τον συγχρονισμό στην Συλλογή όπως παραπάνω.

Από το itunes τραβάει τα metadata artist, tittle, album, genre, year, date added, play count, date last played, rating.


SHORTCUTS

Ο player ακόμη παίζει μόνο με keyboard shortcuts. Αυτά τα βρίσκετε στο menu Βοήθεια


Για τα ALAC

Αν έχουμε επιλέξει να γίνεται μετατροπή των ALAC, μετατρέπει τα αρχεία σε ειδικό φάκελο (Converted στo main μουσικό
path), περνάει αυτά στην database και τα original τα μετονομάζει σε file.m4a.converted. Η μετονομασία γίνεται,
γιατί αλλιώς κάθε φορά που γίνεται συγχρονισμός θα κοιτάει και γι'αυτά πάλι. Κάποια στιγμή θα υπάρξει σκριπτάκι αν
θέλουμε να τα μετονομάσουμε όλα αυτά μαζικά πάλι στο original τους.


ΚΑΤΕΒΑΣΜΑ ΑΠΟ YOUTUBE

Στην συλλογή, στο text area που έχει, αντιγράφουμε τα youtube links που θέλουμε να κατεβάσουμε χωρισμένα από με ','.
Πατάμε Download Youtube και περιμένουμε να κατέβουν. Μετά το κατέβασμα γίνεται αυτόματα συγχρονισμός και
περνιούνται στην database. Κοίτα στις απαιτήσεις για κατέβασμα από youtube.

ΠΡΟΣΟΧΗ: Για να κατεβάσει από youtube πρέπει να έχουμε σετάρει music video path (με main) στην Συλλογή/Διαδρομές αρχείων
και να έχει write δικαιώματα εκεί ο www-data.



ΑΠΑΙΤΗΣΕΙΣ ΕΦΑΡΜΟΓΗΣ

Απαιτεί εγκατάσταση σε linux (apache), γιατί χρησιμοποιούνται κάποιες linux εφαρμογές και άλλες command line εντολές.

Για μετατροπή ALAC πρέπει να εγκαταστήσουμε

ffmpeg
lame

π.χ. για ubuntu

sudo apt-get install ffmpeg
sudo apt-get install lame


Για κατέβασμα από youTube πρέπει να εγκαταστήσουμε το youtube-dl (https://rg3.github.io/youtube-dl/download.html)

π.χ.

sudo wget https://yt-dl.org/downloads/latest/youtube-dl -O /usr/local/bin/youtube-dl

sudo chmod a+rx /usr/local/bin/youtube-dl


Προσοχή πρέπει να δοθεί στα δικαιώματα των paths ώστε η εφαρμογή να μπορεί να δημιουργήσει φακέλους για κατέβασμα,
αλλά και να σβήσει αρχεία όταν επιλέγουμε να σβήσουμε μέσα από την εφαρμογή. Πρέπει να έχει δικαιώματα read/write.



ΜΟΙΡΑΣΜΑ ΔΙΣΚΩΝ ΜΕ SAMBA ΑΝ ΟΙ ΔΙΣΚΟΙ ΔΕΝ ΕΙΝΑΙ ΣΤΟ ΙΔΙΟ ΜΗΧΑΝΗΜΑ ΜΕ ΤΟΝ WEB SERVER

Μοιράζουμε τον δίσκο με samba (είτε από linux, είτε από windows, είτε από Mac OS) και κάνουμε τον δίσκο mount
στο μηχάνημα που είναι ο web server. π.χ. μπορεί να τρέχει σε virtualbox

Για μόνιμα βάζουμε την απαραίτητη γραμμή στο αρχείο /etc/fstab

π.χ. sudo nano /etc/fstab

και προσθέτουμε κάτι σαν αυτό

//192.168.1.150/diskname  /media/diskname  cifs  credentials=/home/user/.creds,iocharset=utf8,sec=ntlm,noperm,rw

και στην συνέχεια restart ή sudo mount -a

στο /home/user/.creds βάζουμε τα samba username, password σε γραμμές τύπου
username=user
password=pass



ΓΝΩΣΤΑ ΠΡΟΒΛΗΜΑΤΑ

Η εφαρμογή (ειδικά ο fullscreen player) παίζει μόνο σε chrome προς το παρόν.

Ο safari δεν υποστηρίζει keyboard shortcuts όταν είναι σε fullscreen για λόγους ασφαλείας

Ο firefox δεν εμφανίζει το overlay σε fullscreen

Προσοχή στα filenames των αρχείων να μην έχουν περίεργους ειδικούς χαρακτήρες, αλλιώς δεν θα αναγνωρίζονται
και θα βγάζει πρόβλημα στον συγχρονισμό. π.χ. αν ένα αρχείο έχει τον χαρακτήρα '+' τότε "χτυπάει".

Πρόβλημα έχει και με τα Ελληνικά metatags σε κάποια mp3. Περνιούνται στην database αλλά σε κάποια μπορεί να
βλέπει "κινέζικα".

Το interface σε καμιά περίπτωση δεν είναι τελειωμένο, αλλά τα βασικά γίνονται κανονικά.

Τα κείμενα σε κάποια σημεία δεν είναι ακόμη πολυγλωσσικά και ίσως λάθος.

Ο player παίζει ακόμη μόνο σε autoplay και shuffle. Δηλαδή με κάθε αναζήτηση παίζει αυτόματα τα τραγούδια σε τυχαία
σειρά.




ΣΗΜΕΙΩΣΕΙΣ

Για τα αρχεία σας δεν υπάρχει πρόβλημα να διαγράψει κάτι. Όπου χρειάζεται (όταν πατήσουμε εμείς διαγραφή) ρωτάει πρώτα
για επιβεβαίωση. Ενώ όταν θέλει να διαγράψει μαζικά αρχεία (στον συγχρονισμό π.χ αν βρει διπλά αρχεία) πάλι
ρωτάει και χρειάζεται επιβεβαίωση.

Επίσης δεν κάνει edit κανένα αρχείο. Όλα τα metadata γράφονται στην βάση δεδομένων και τα artworks σώζονται σε σχετικό
directory.


UPDATE ΤΩΝ ΑΡΧΕΙΩΝ ΤΗΣ ΕΦΑΡΜΟΓΗΣ

Κατεβάζουμε τα αρχεία από το project και τα αντιγράφουμε πάνω στα προηγούμενα.
Εναλλακτικά χρησιμοποιούμε το git για αυτόματα

sudo git pull



ΜΑΖΙΚΟ ΣΒΗΣΙΜΟ ΤΩΝ ΑΡΧΕΙΩΝ ΠΟΥ ΕΧΟΥΝ ΣΥΓΧΡΟΝΙΣΤΕΙ ΑΠΟ ΤΗΝ ΒΑΣΗ

Αν χρειαστεί να κάνετε δοκιμές στην αρχή και θέλετε να σβήσετε ότι έχετε συγχρονίσει, για να ξαναδοκιμάσετε, 2 είναι
οι σχετικοί πίνακες που αφορούν την library. Ο files και ο music_tags. Επειδή υπάρχει συσχετισμός πρέπει να σβήσετε
πρωτα τα περιεχόμενα του music_tags και μετά του files.

Δηλαδή οι εντολές που θα τρέξετε στην mysql είναι:

DELETE FROM music_tags;
DELETE FROM files;


CHANGE LOG

17-11-2016: 0.1.202
    Φτιάξιμο της progress bar και του τερματισμού και στα υπολοιπα στοιχεία της οθόνης συγχρονισμού
    Τα controls του player κρύβονται πλέον και στον safari
    Έλεγχος της βάσης αν έχει όλα τα tables και δημιουργία αυτών που δεν υπάρχουν
16-11-2016: 0.1.201
    Διόρθωση του progress στο κατέβασμα από youtube και τερματισμός του download
    Διόρθωση της εμφάνισης του album στην λίστα, μετά από μαζικό editing
14-11-2016: 0.1.200
    Καθαρίζει την βάση από προσωρινούς πίνακες που δεν χρησιμοποιούνται άλλο
13-11-2016: 0.1.107
    Κρατάει διαφορετικό tabID για να προσθέτει στο όνομα της προσωρινής playlist
    Σκοτώνει τα interval process στον συγχρονισμό
    Ενημερώνει το session του χρήστη κάθε φορά που παίρνει τα video metadata
    Πιθανή διόρθωση του player, που παίζει ξανα λίγο από την αρχή του τραγουδιού όταν πάει στο επόμενο και δεν
    το έχει φορτώσει ακόμη
08-11-2016: 0.1.106
    Εμφάνιση του progress bar πάνω στην mainbar
    Εμφάνιση των τελικών αποτελεσμάτων συγχρονισμού ακόμη κι όταν ο χρήστης βρίσκεται σε άλλη οθόνη
07-11-2016: 0.1.105
    Διόρθωση του progress percent που δεν έβαζε το απαραίτητο value στον πίνακα progress της βάσης
    Έλεγχος αν τρέχει ένα script (π.χ. συγχρονισμός) και σκότωμα του όταν θέλουμε
05-11-2016: 0.1.104
    Υλοποίηση του player με αντιγραφή της playlist σε προσωρινά mysql tables. Για κάθε χρήστη δημιουργείται
    ξεχωριστό προσωρινό playlist table
04-11-2016: 0.1.103
    Έλεγχος έκδοσης της εφαρμογής, με βάση την τρέχουσα έκδοση αν θέλει ενημέρωση
    Διορθώσεις σε bugs στην πλοήγηση στο μενου
    Διορθώσεις στην αναζήτηση
    Πρώτα βήματα για αλλαγή του συστήματος που δουλεύει ο player με αντιγραφή mysql tables
    Αποφασίστηκε το τελικό όνομα της εφαρμογής, Parrot Tunes.
03-11-2016: 0.1.102
    Διορθώσεις σε ζητήματα της αναζήτησης, ειδικά μετά από πλοήγηση στο μενου
    Βελτίωση της εμφάνισης του loading gif
    Προστέθηκε Progress bar στον συγχρονισμό
28-10-2016: 0.1.101
    Διορθώσεις σε στοιχεία που είχαν πρόβλημα όταν έμπαινες σαν απλός χρήστης
27-10-2016: 0.1.100
    Βελτιώσεις στην εμφάνιση και διόρθωση του bug στην πλοήγηση στο μενου

